
# Set software locations here:
# TCL = $(HOME)/sfw/tcl-8.6.1
TCL = /usr
# TCL = $(HOME)/sfw/tcl-8.5.9-x86_64
TCLSH = $(wildcard $(TCL)/bin/tclsh8.* )
TCL_INCLUDE = /usr/include/tcl
TCL_LIB =  /usr/lib/x86_64-linux-gnu

# Set Tcl version here:
TCL_VERSION = 8.5
# TCL_VERSION = 8.6

INCLUDES = -I $(NLOPT)/include -I $(TCL_INCLUDE) -I src

CFLAGS += @CFLAGS@
CFLAGS += $(INCLUDES) -g -Wall -fPIC -std=gnu99

LDFLAGS += @LDFLAGS@

LIBDIRS += -L $(NLOPT)/lib

LIBS += $(LIBDIRS) -lnlopt -lm

RPATHS = @RPATHS@ \
         -Wl,-rpath -Wl,$(PWD)/lib

EXECUTABLES = bin/fop-nlopt bin/fo-nlopt \
              bin/MedianImage bin/ImageProcessing

all: $(EXECUTABLES)

swift-pkg: pkgIndex.tcl

sanity:
#       Test that we have NLopt
	test -d $(NLOPT)

bin:
	mkdir -pv bin

LIBNFHEDM = lib/libnfhedm.so
LIBTCLNFHEDM = lib/libtclnfhedm.so

lib: $(LIBNFHEDM)

NFHEDM_NLOPT_OBJS = src/FitOrientationParametersNLOpt.o \
                 src/FitOrientation.o                \
                 src/SharedFuncsFit.o                \
                 src/CalcDiffractionSpots.o          \
                 src/swift-bindings.o                \
                 src/placebo.o                       \
                 src/parameters.o

HEADERS = src/checks.h src/SharedFuncsFit.h src/CalcDiffractionSpots.h \
           src/swift-bindings.h

src/CalcDiffractionSpots.o: src/CalcDiffractionSpots.c $(HEADERS)

src/FitOrientationParametersNLOpt-main.o:        \
	src/FitOrientationParametersNLOpt-main.c \
	$(HEADERS)
	gcc -c $(CFLAGS) -o $(@) $(<)

bin/fop-nlopt:  $(LIBNFHEDM)                                           \
                src/FitOrientationParametersNLOpt-main.o
	@mkdir -pv bin
	gcc $(LDFLAGS)                                           \
		-o $(@) src/FitOrientationParametersNLOpt-main.o \
		-L lib -l nfhedm                                    \
		$(LIBS)                                          \
		$(RPATHS)                                        \

bin/fo-nlopt:  $(LIBNFHEDM)                                           \
                src/FitOrientation-main.o
	@mkdir -pv bin
	gcc $(LDFLAGS)                                           \
		-o $(@) src/FitOrientation-main.o \
		-L lib -l nfhedm                                    \
		$(LIBS)                                          \
		$(RPATHS)

bin/MedianImage: $(LIBNFHEDM) src/MedianImage.c
	gcc -o $(@)               \
	       $(CFLAGS)          \
	       src/MedianImage.c  \
	       $(LDFLAGS)         \
	       $(RPATHS)

 # \
 # 	           -I $(DIP)/include                  \
 # 	           -L $(DIP)/lib -ldipio -ldip -lm

bin/ImageProcessing: src/ImageProcessing.c
	gcc -o bin/ImageProcessing src/ImageProcessing.c -lm

$(LIBNFHEDM): sanity $(NFHEDM_NLOPT_OBJS)
	@mkdir -pv lib
	gcc -shared -o $(@)       \
		$(NFHEDM_NLOPT_OBJS) \
	        $(LDFLAGS)
		$(RPATH_NLOPT)

$(LIBTCLNFHEDM): sanity src/nfhedm_wrap.o $(NFHEDM_NLOPT_OBJS)
	gcc -shared -o $(@)         \
		src/nfhedm_wrap.o  \
		$(NFHEDM_NLOPT_OBJS)   \
		$(LIBS)             \
		-L $(TCL_LIB) -l tcl$(TCL_VERSION) \
		$(RPATH_NLOPT) -Wl,-rpath -Wl,$(TCL)/lib

src/nfhedm_wrap.c: src/nfhedm.i
	swig $(<)

pkgIndex.tcl: $(LIBTCLNFHEDM) make-package.tcl
	LEAF_PKG=tclnfhedm LEAF_VERSION=0.0  \
	LEAF_SO=$(<) LEAF_TCL=tcl/nfhedm.tcl \
	$(TCLSH) make-package.tcl > $(@)

TESTS = tests/test-placebo.x

tests: $(TESTS)

%.x: %.o $(LIBNFHEDM)
	gcc -o $(@) $(<)      \
		-L lib -l nfhedm \
		$(RPATHS)

clean:
	@echo CLEAN
	rm -fv $(EXECUTABLES)
	rm -fv src/*.o
	rm -fv src/nfhedm_wrap.c
	rm -fv lib/libtclnfhedm.so lib/libnfhedm.so
	rm -fv $(TESTS)
	@echo

.PHONY: sanity clean all
