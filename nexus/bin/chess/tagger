#!/bin/zsh

set -eu

SRC=/nfs/chess/daq/2015-3/a2/rosenkranz-311-1
DST=/nfs/chess/aps/rosenkranz-311-1

MT2=${HOME}/proj/d-e/mt2/bin/mt2
MK_LINKS=${HOME}/proj/d-e/nexus/bin/chess/mk-links.py

LIST=$( mktemp /tmp/wozniak-list-XXX.txt )

LAST_STAMP=0
while true
do
  cd ${SRC}
  print "Looking for spec.done ..."
  LATEST_DONE=$( stat --format %Y **/spec.done(om[1]) )
  if (( ${LATEST_DONE} <= ${LAST_STAMP} ))
  then
      print sleep
      sleep 60
      continue
  fi

  python ${MK_LINKS} \
         $( readlink ~/rosenkranz-311-1 ) \
         $( readlink ~/aps )
  
  NOT_STACKED=()
  
  foreach SD in **/spec.done 
  do
    D=$( dirname ${SD} )
    NXS=${DST}/${D}.nxs
    if [[ ! -f ${NXS} ]]
    then
        print "Found WORK: ${SD}"
        NOT_STACKED+=${SD}
    else
      print "Found NXS:  ${NXS}"
    fi
  done
  
  if [[ ${#NOT_STACKED} == 0 ]]
  then
    print sleep
    sleep 60
    continue
  fi
  LATEST=$( ls -t ${NOT_STACKED} | tail -1 )
  d LATEST
  D=$( dirname ${LATEST} )
  cd ${DST}
  print -l ${DST}/${D}/*.tiff | sort > ${LIST}
  d LIST D
  @ nice ${MT2} 2463 2527 3700 ${DST}/${D}.nxs < ${LIST}
  print
done |& tee ~/tagger.log
