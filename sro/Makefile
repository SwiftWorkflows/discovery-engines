
all: sro

CC = h5cc
FLAGS = -Wall -g -O0
INCLUDES = -I .

ifeq ($(FAST),1)
	FLAGS += -O3
endif
ifeq (py,$(findstring py,$(MAKECMDGOALS)))
	FLAGS += -fPIC
	INCLUDES += -I /usr/include/python2.7
endif

FFLAGS = $(FLAGS) -fimplicit-none -Wuninitialized -pedantic -cpp
CFLAGS = $(FLAGS) $(INCLUDES) -std=gnu99

HDF_LIBS = -L /usr/lib/x86_64-linux-gnu/hdf5/serial -l hdf5_fortran \
		-Wl,-rpath -Wl,/usr/lib/x86_64-linux-gnu/hdf5/serial

py: _libpysro.so

%.o: %.f90
	h5fc -c -o $(@) $(<) \
		$(FFLAGS)

OBJS_CORE = sro-calc.o io.o sro-defn.o

include tests/module.mk

# Module dependencies
main.o: sro-calc.o
sro-calc.o: io.o
io.o: sro-defn.o

sro: main.o $(OBJS_CORE)
	h5fc -o $(@) $(^)

test-c-sro.x: test-c-sro.o $(OBJS_CORE)
	$(CC) -o $(@) $(^) -lgfortran

sro_wrap.c: sro.i sro.h
	swig -python $(<)

_libpysro.so: sro_wrap.o sro-helpers.o $(OBJS_CORE)
	gcc -shared -o $(@) $(^) \
		-L /usr/lib/x86_64-linux-gnu -l python2.7 \
		-l gfortran \
		$(HDF_LIBS)
clean:
	rm -fv sro *.x *.so *.o *.mod *_wrap.c
# 	This script is generated by SWIG:
	rm -fv libpysro.py
	rm -fv *.pyc

.PRECIOUS: %.o
