
CC = h5cc
FLAGS = -Wall -g

ifeq ($(FAST),1)
	FLAGS += -O3
endif
ifeq (py,$(findstring py,$(MAKECMDGOALS)))
	FLAGS += -fPIC
	INCLUDES += -I /usr/include/python2.7
endif

FFLAGS = $(FLAGS) -fimplicit-none -Wuninitialized -pedantic -cpp
CFLAGS = $(FLAGS) $(INCLUDES)

HDF_LIBS = -L /usr/lib/x86_64-linux-gnu/hdf5/serial -l hdf5_fortran \
		-Wl,-rpath -Wl,/usr/lib/x86_64-linux-gnu/hdf5/serial

all: sro

include tests/module.mk

py: _libpysro.so

%.o: %.f90
	h5fc -c -o $(@) $(<) \
		$(FFLAGS)

main.o: io.o sro.o # Module dependencies

sro: main.o sro.o io.o
	h5fc -o $(@) $(^)

# Pure ordering dependency
io.o: sro.o

test-c-sro.x: test-c-sro.o io.o sro.o
	$(CC) -o $(@) $(^) -lgfortran

sro_wrap.c: sro.i sro.h
	swig -python $(<)

_libpysro.so: sro_wrap.o sro-helpers.o io.o sro.o
	gcc -shared -o $(@) $(^) \
		-L /usr/lib/x86_64-linux-gnu -l python2.7 \
		-l gfortran \
		$(HDF_LIBS)
clean:
	rm -fv sro *.x *.so *.o *.mod *_wrap.c
# 	This script is generated by SWIG:
	rm -fv libpysro.py
	rm -fv *.pyc
